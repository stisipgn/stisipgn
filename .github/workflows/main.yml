name: macOS_GUI_Remote_SelfHosted

on:
  workflow_dispatch:

jobs:
  macos-vnc:
    runs-on: self-hosted
    timeout-minutes: 2000 # 43200 30 hari (praktis unlimited)

    steps:
      - name: Show macOS Info
        shell: bash
        run: |
          echo "=== macOS Info ==="
          sw_vers
          uname -a

      - name: Install Tailscale (macOS)
        shell: bash
        run: |
          echo "Downloading latest Tailscale package..."
          curl -fsSL -o tailscale.pkg https://pkgs.tailscale.com/stable/Tailscale-latest-macos.pkg
          sudo installer -pkg tailscale.pkg -target /
          rm tailscale.pkg
          echo "‚úÖ Tailscale installed!"
          /Applications/Tailscale.app/Contents/MacOS/tailscale version

      - name: Start Tailscale Daemon
        shell: bash
        run: |
          sudo /Applications/Tailscale.app/Contents/MacOS/tailscaled &
          sleep 5

      - name: Connect to Tailscale Network
        shell: bash
        env:
          TS_AUTHKEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          sudo /Applications/Tailscale.app/Contents/MacOS/tailscale up \
            --authkey=${TS_AUTHKEY} \
            --hostname=selfhosted-macos-${{ github.run_id }} \
            --accept-dns=false
          echo "TAILSCALE_IP=$(/Applications/Tailscale.app/Contents/MacOS/tailscale ip -4)" >> $GITHUB_ENV
          echo "‚úÖ Connected to Tailscale network!"

      - name: Verify Tailscale
        shell: bash
        run: |
          echo "üîç Checking Tailscale status..."
          /Applications/Tailscale.app/Contents/MacOS/tailscale status
          echo "Tailscale IP: $TAILSCALE_IP"

      - name: Create GUI User
        shell: bash
        run: |
          USERNAME="guiuser"
          PASSWORD=$(openssl rand -base64 12)
          echo "::add-mask::$PASSWORD"
          sudo sysadminctl -addUser $USERNAME -password $PASSWORD
          sudo dscl . -append /Groups/admin GroupMembership $USERNAME
          echo "GUI_USER=$USERNAME" >> $GITHUB_ENV
          echo "GUI_PASS=$PASSWORD" >> $GITHUB_ENV
          echo "Created user: $USERNAME"

      - name: Enable VNC Access
        shell: bash
        run: |
          echo "üîß Enabling Screen Sharing..."
          sudo systemsetup -setremotedesktop on
          sudo defaults write /Library/Preferences/com.apple.RemoteManagement VNCAlwaysStartOnConsole -bool true
          sudo defaults write /Library/Preferences/com.apple.RemoteManagement VNCEnabled -bool true
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw $GUI_PASS \
            -restart -agent -privs -all

          sudo /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate on
          sudo /usr/libexec/ApplicationFirewall/socketfilterfw --add /System/Library/CoreServices/RemoteManagement/ARDAgent.app
          sudo /usr/libexec/ApplicationFirewall/socketfilterfw --unblockapp /System/Library/CoreServices/RemoteManagement/ARDAgent.app
          echo "‚úÖ Screen Sharing enabled (port 5900)"

      - name: Display Access Info
        shell: bash
        run: |
          echo "=============================================="
          echo "üçè macOS GUI Remote Ready via Tailscale!"
          echo "üîó Connect using any VNC viewer:"
          echo "    Address : $TAILSCALE_IP:5900"
          echo "    Username: $GUI_USER"
          echo "    Password: $GUI_PASS"
          echo "----------------------------------------------"
          echo "üí° On Windows: use RealVNC / TightVNC"
          echo "üí° On Linux  : use Remmina / Vinagre"
          echo "üí° On macOS  : use Finder ‚Üí Go ‚Üí Connect to Server ‚Üí vnc://$TAILSCALE_IP"
          echo "=============================================="
          echo "üí§ Keeping session active indefinitely..."
          while true; do
            echo "[$(date)] macOS GUI active on $TAILSCALE_IP"
            sleep 300
          done
