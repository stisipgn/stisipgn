name: macOS Headless VNC

on:
  workflow_dispatch:

jobs:
  vnc:
    runs-on: macos-14

    steps:
      - name: Install XQuartz
        run: |
          curl -L -o XQuartz.pkg https://github.com/XQuartz/XQuartz/releases/download/XQuartz-2.8.5/XQuartz-2.8.5.pkg
          sudo installer -pkg XQuartz.pkg -target /

      - name: Install TigerVNC
        run: |
          brew install tigervnc
          echo "Pilih password random"
          PASS=$(openssl rand -base64 12)
          echo "$PASS" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          echo "VNC_PASS=$PASS" >> $GITHUB_ENV

      - name: Start Fake X11 Desktop (Xvnc)
        run: |
          mkdir -p ~/.vnc
          cat <<EOF > ~/.vnc/xstartup
#!/bin/sh
export PATH=/opt/X11/bin:$PATH
xrdb $HOME/.Xresources
xclock &
xterm &
EOF
          chmod +x ~/.vnc/xstartup

          echo "Start VNC server..."
          /opt/homebrew/bin/Xvnc :0 -geometry 1440x900 -localhost no \
              -rfbauth ~/.vnc/passwd \
              -pn -listen tcp &

          sleep 3
          echo "VNC server started"

      - name: Install Tailscale
        run: |
          brew install tailscale
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=macos-vnc-$GITHUB_RUN_ID

          echo "TAILSCALE_IP=$(tailscale ip -4)" >> $GITHUB_ENV

      - name: Keep Alive
        run: |
          echo "===== CONNECT WITH VNC ====="
          echo "IP: $TAILSCALE_IP"
          echo "PORT: 5900"
          echo "Password: $VNC_PASS"
          echo "============================"
          while true; do sleep 60; done
