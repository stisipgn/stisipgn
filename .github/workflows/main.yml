name: macOS_GUI_Remote_Cloud

on:
  workflow_dispatch:

jobs:
  macos-vnc:
    runs-on: macos-15-arm64
    timeout-minutes: 2000

    steps:
      - name: Show macOS Info
        run: |
          echo "=== macOS Info ==="
          sw_vers
          uname -a

      - name: Install Tailscale
        run: |
          echo "üì¶ Installing Tailscale..."
          curl -fsSL -o tailscale.pkg https://pkgs.tailscale.com/stable/Tailscale-latest-macos.pkg
          sudo installer -pkg tailscale.pkg -target /
          rm tailscale.pkg
          echo "‚úÖ Tailscale installed!"
          sudo /Applications/Tailscale.app/Contents/MacOS/tailscaled &

      - name: Connect to Tailscale
        env:
          TS_AUTHKEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          sleep 5
          echo "üîó Connecting to Tailscale network..."
          sudo /Applications/Tailscale.app/Contents/MacOS/tailscale up \
            --authkey=${TS_AUTHKEY} \
            --hostname=macos-gh-${{ github.run_id }} \
            --accept-dns=false
          echo "TAILSCALE_IP=$(/Applications/Tailscale.app/Contents/MacOS/tailscale ip -4)" >> $GITHUB_ENV
          echo "‚úÖ Connected to Tailscale network!"

      - name: Enable VNC Access
        run: |
          echo "üîß Enabling Screen Sharing..."
          PASSWORD=$(openssl rand -base64 8)
          sudo sysadminctl -addUser vncuser -password $PASSWORD
          sudo dscl . -append /Groups/admin GroupMembership vncuser
          echo "VNC_USER=vncuser" >> $GITHUB_ENV
          echo "VNC_PASS=$PASSWORD" >> $GITHUB_ENV

          sudo systemsetup -setremotedesktop on
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw $PASSWORD \
            -restart -agent -privs -all

          sudo /usr/libexec/ApplicationFirewall/socketfilterfw --setglobalstate on
          sudo /usr/libexec/ApplicationFirewall/socketfilterfw --add /System/Library/CoreServices/RemoteManagement/ARDAgent.app
          sudo /usr/libexec/ApplicationFirewall/socketfilterfw --unblockapp /System/Library/CoreServices/RemoteManagement/ARDAgent.app

          echo "‚úÖ Screen Sharing enabled (port 5900)"

      - name: Show Connection Info
        run: |
          echo "====================================="
          echo "üçè macOS GUI Remote is READY!"
          echo "üîó Connect using your VNC client:"
          echo "    Address : $TAILSCALE_IP:5900"
          echo "    Username: $VNC_USER"
          echo "    Password: $VNC_PASS"
          echo "====================================="
          echo "üí° Tips:"
          echo "   ‚Ä¢ On Windows: use RealVNC / TightVNC"
          echo "   ‚Ä¢ On Linux : use Remmina / Vinagre"
          echo "   ‚Ä¢ On macOS : Finder ‚Üí Go ‚Üí Connect to Server ‚Üí vnc://$TAILSCALE_IP"
          echo "====================================="

      - name: Keep Alive
        run: |
          echo "üí§ Keeping session alive for up to 2000 minutes..."
          for i in {1..400}; do
            echo "[$(date)] macOS GUI active at $TAILSCALE_IP (iteration $i/400)"
            sleep 300
          done
