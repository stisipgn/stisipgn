name: xxx

on:
  workflow_dispatch:

jobs:
  secure-vnc:
    runs-on: macos-16
    timeout-minutes: 360

    steps:

      # 1. Enable VNC
      - name: Generate Password and Enable VNC
        run: |
          VNC_PASS=$(openssl rand -base64 12)
          echo "VNC_PASSWORD=$VNC_PASS" >> $GITHUB_ENV
          echo "Password VNC: $VNC_PASS"

          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate \
            -configure \
            -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "$VNC_PASS" \
            -restart -agent \
            -privs -all -users runner


      # 2. FIX BLACK SCREEN (AMAN): Force GUI by opening apps
      - name: Start GUI Desktop Environment (Safe Mode)
        run: |
          echo "Starting macOS GUI apps to activate WindowServer..."

          sudo -u runner open -a Finder || true
          sudo -u runner open -a Safari || true
          sudo -u runner open -a TextEdit || true
          sudo -u runner open -a Terminal || true

          echo "Waiting for GUI to initialize..."
          sleep 8


      # 3. Reset screen capture permissions
      - name: Reset Screen Permissions
        run: |
          sudo tccutil reset ScreenCapture || true
          sudo tccutil reset ScreenRecording || true
          sudo tccutil reset Accessibility || true

          sudo -u runner open -a Finder || true
          sleep 4


      # 4. Install Tailscale
      - name: Install Tailscale via Homebrew
        run: brew install tailscale


      # 5. Connect Tailscale
      - name: Establish Tailscale Connection
        run: |
          TS_BIN=$(which tailscale)
          echo "Tailscale binary: $TS_BIN"

          sudo brew services start tailscale
          sleep 4

          sudo $TS_BIN up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=gh-runner-macos-$GITHUB_RUN_ID

          sleep 4

          tsIP="$($TS_BIN ip -4)"
          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
          echo "Tailscale IP: $tsIP"


      # 6. Test port VNC
      - name: Verify VNC
        run: nc -z -v $TAILSCALE_IP 5900


      # 7. Keep connection open
      - name: Maintain Connection
        run: |
          TS_BIN=$(which tailscale)

          echo "===== VNC ACCESS ====="
          echo "IP: $TAILSCALE_IP"
          echo "Port: 5900"
          echo "User: runner"
          echo "Password: $VNC_PASSWORD"
          echo "======================"

          while true; do
            echo "[$(date)] VNC running..."
            $TS_BIN status
            sleep 300
          done
