name: MacOS VNC - Fix Black Screen

on:
  workflow_dispatch:

jobs:
  secure-vnc:
    runs-on: macos-14
    timeout-minutes: 360

    steps:
      # 1. Enable VNC dengan approach yang berbeda
      - name: Enable Screen Sharing Properly
        run: |
          VNC_PASS=$(openssl rand -base64 12)
          echo "VNC_PASSWORD=$VNC_PASS" >> $GITHUB_ENV
          
          # Method 1: Enable via systemsetup (lebih reliable)
          sudo systemsetup -setremotelogin on || true
          
          # Method 2: Enable Screen Sharing service
          sudo launchctl enable system/com.apple.screensharing
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true
          
          # Method 3: ARD sebagai backup
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "$VNC_PASS" \
            -restart -agent -privs -all

      # 2. FIX KRITIS: Screen Recording Permissions
      - name: Fix Screen Recording Permissions
        run: |
          echo "Fixing Screen Recording permissions..."
          
          # Reset semua permissions screen recording
          sudo tccutil reset ScreenCapture
          sudo tccutil reset ScreenRecording
          sudo tccutil reset Accessibility
          
          # Berikan permissions ke processes yang diperlukan (SOLUSI UTAMA)
          sudo sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" \
            "DELETE FROM access WHERE client='com.apple.screensharing';" 2>/dev/null || true
          
          sudo sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceScreenCapture','com.apple.screensharing',0,1,1,NULL,NULL,NULL,'UNUSED',NULL,0,$(date +%s));" 2>/dev/null || true
          
          sudo sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" \
            "INSERT OR REPLACE INTO access VALUES('kTCCServiceScreenRecording','com.apple.screensharing',0,1,1,NULL,NULL,NULL,'UNUSED',NULL,0,$(date +%s));" 2>/dev/null || true

      # 3. Force Active User Session
      - name: Create Active GUI Session
        run: |
          echo "Creating active GUI session..."
          
          # Pastikan loginwindow berjalan
          sudo launchctl kickstart -k system/com.apple.loginwindow || true
          
          # Buat session aktif dengan cara yang lebih agresif
          for i in {1..10}; do
            echo "Attempt $i to create GUI session..."
            
            # Force launch Finder sebagai user
            sudo -u runner osascript -e 'tell application "Finder" to activate' 2>/dev/null || true
            
            # Launch System Preferences untuk trigger permission dialog
            sudo -u runner open -b com.apple.systempreferences 2>/dev/null || true
            
            # Buka aplikasi yang membutuhkan screen recording
            sudo -u runner open -a Calculator 2>/dev/null || true
            
            sleep 3
          done

      # 4. Alternative: Enable via plist (Method dari Reddit)
      - name: Alternative Screen Sharing Enable
        run: |
          # Enable via preferences
          sudo defaults write /var/db/launchd.db/com.apple.launchd/overrides.plist com.apple.screensharing -dict Disabled -bool false
          sudo launchctl load /System/Library/LaunchDaemons/com.apple.screensharing.plist 2>/dev/null || true
          
          # Set VNC password via system preferences
          sudo defaults write /Library/Preferences/com.apple.VNCSettings TextPassword -string "$VNC_PASSWORD"
          sudo defaults write /Library/Preferences/com.apple.VNCSettings TextOnly -bool false

      # 5. Final Permission Fix (Nuclear Option)
      - name: Nuclear Permission Fix
        run: |
          # Grant permissions ke semua system processes
          for bundle in "com.apple.screensharing" "com.apple.Terminal" "com.apple.loginwindow" "com.apple.WindowServer"; do
            sudo sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" \
              "INSERT OR REPLACE INTO access VALUES('kTCCServiceScreenRecording','$bundle',0,1,1,NULL,NULL,NULL,'UNUSED',NULL,0,$(date +%s));" 2>/dev/null || true
            sudo sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" \
              "INSERT OR REPLACE INTO access VALUES('kTCCServiceScreenCapture','$bundle',0,1,1,NULL,NULL,NULL,'UNUSED',NULL,0,$(date +%s));" 2>/dev/null || true
          done

      # 6. Restart Services dengan benar
      - name: Restart GUI Services
        run: |
          echo "Restarting GUI services..."
          
          # Restart services terkait GUI
          sudo pkill -f "Screen Sharing" 2>/dev/null || true
          sudo pkill -f "ARDAgent" 2>/dev/null || true
          
          sleep 5
          
          # Start services kembali
          sudo launchctl start com.apple.screensharing 2>/dev/null || true
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -restart -agent

      # 7. Install Tailscale
      - name: Setup Tailscale
        run: |
          brew install tailscale
          sudo brew services start tailscale
          sleep 10
          
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=gh-runner-macos-$GITHUB_RUN_ID
          
          sleep 5
          echo "TAILSCALE_IP=$(tailscale ip -4)" >> $GITHUB_ENV

      # 8. Verify dengan comprehensive check
      - name: Verify VNC Connection
        run: |
          echo "=== Comprehensive VNC Check ==="
          
          # Check service status
          echo "1. Screen Sharing Service:"
          sudo launchctl list | grep -i screen && echo "✅ RUNNING" || echo "❌ STOPPED"
          
          echo "2. VNC Port:"
          nc -z -v localhost 5900 && echo "✅ PORT 5900 OPEN" || echo "❌ PORT 5900 CLOSED"
          
          echo "3. Remote Management:"
          sudo systemsetup -getremotelogin | grep "On" && echo "✅ REMOTE LOGIN ON" || echo "❌ REMOTE LOGIN OFF"
          
          echo "4. Active Screen Session:"
          pgrep -x "WindowServer" && echo "✅ WINDOWSERVER ACTIVE" || echo "❌ WINDOWSERVER INACTIVE"
          
          echo "5. TCC Permissions:"
          sudo sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" "SELECT * FROM access WHERE service='kTCCServiceScreenRecording';" 2>/dev/null && echo "✅ SCREEN RECORDING PERMISSIONS SET" || echo "❌ PERMISSIONS MISSING"

      # 9. Keep Alive
      - name: Maintain Connection
        run: |
          echo "=== VNC ACCESS - NO BLACK SCREEN ==="
          echo "IP: $TAILSCALE_IP:5900"
          echo "User: runner"
          echo "Password: $VNC_PASSWORD"
          echo "===================================="
          
          # Continuous health monitoring
          counter=0
          while true; do
            echo "[$(date +'%H:%M:%S')] VNC Active - Checking health..."
            
            # Periodic service health check
            if [ $((counter % 10)) -eq 0 ]; then
              nc -z -w 1 localhost 5900 && echo "✅ VNC Healthy" || echo "❌ VNC Issues"
              tailscale status
            fi
            
            sleep 30
            counter=$((counter + 1))
          done
