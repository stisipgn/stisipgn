name: MacOS VNC Setup (TigerVNC)

on:
  workflow_dispatch:

jobs:
  virtual-vnc:
    runs-on: macos-14
    timeout-minutes: 360

    steps:
      # 1. Install Dependencies (TigerVNC dan XQuartz)
      - name: Install Dependencies
        run: |
          brew update
          brew install tigervnc
          # XQuartz diperlukan untuk lingkungan X11
          brew install --cask xquartz

      # 2. Configure and Start TigerVNC
      - name: Configure and Start TigerVNC
        run: |
          # Buat password VNC 8 karakter secara acak
          VNC_PASS=$(openssl rand -base64 6)
          echo "VNC_PASSWORD=$VNC_PASS" >> $GITHUB_ENV
          echo "::add-mask::$VNC_PASS"
          
          # Buat file password VNC
          mkdir -p ~/.vnc
          echo "$VNC_PASS" | vncpasswd -f > ~/.vnc/passwd
          chmod 600 ~/.vnc/passwd
          
          # Jalankan server VNC di display :1 (port 5901)
          # -localhost no agar bisa diakses dari IP Tailscale
          vncserver :1 -localhost no -geometry 1920x1080 -depth 24
          
          echo "TigerVNC server dimulai di port 5901"

      # 3. Install Tailscale
      - name: Install Tailscale
        run: |
          brew install tailscale

      # 4. Connect Tailscale
      - name: Connect Tailscale
        run: |
          sudo brew services start tailscale
          sleep 5
          
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=gh-runner-macos-$GITHUB_RUN_ID
            
          sleep 5
          tsIP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
          echo "Tailscale IP: $tsIP"

      # 5. Keep Alive and Show Details
      - name: Keep Alive
        run: |
          echo "========================================"
          echo "=== Detail Koneksi VNC (TigerVNC) ==="
          echo "========================================"
          echo "IP (via Tailscale): $TAILSCALE_IP"
          echo "Port: 5901"
          echo "Password: $VNC_PASSWORD"
          echo "========================================"
          echo
          echo "CATATAN: Anda terhubung ke desktop VIRTUAL."
          echo "Anda akan melihat layar abu-abu pada awalnya."
          echo "Ini TIDAK akan menampilkan Finder macOS."
          
          # Loop agar koneksi tetap hidup
          while true; do
            echo "[$(date)] Sesi VNC Aktif - IP: $TAILSCALE_IP:5901"
            tailscale status | grep -v 'offline'
            sleep 300
          done
