name: MacOS Secure VNC

on:
  workflow_dispatch:

jobs:
  secure-vnc:
    runs-on: macos-14
    timeout-minutes: 360

    steps:
      # 1. Enable VNC tanpa mengganggu proses existing
      - name: Enable VNC Service
        run: |
          VNC_PASS=$(openssl rand -base64 12)
          echo "VNC_PASSWORD=$VNC_PASS" >> $GITHUB_ENV
          echo "VNC Password: $VNC_PASS"
          
          # Enable VNC without restarting critical services
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate \
            -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "$VNC_PASS" \
            -restart -agent \
            -privs -all

      # 2. Safe GUI activation tanpa kill processes
      - name: Safe GUI Activation
        run: |
          # Only disable sleep/screensaver
          sudo systemsetup -setdisplaysleep Never || true
          sudo systemsetup -setcomputersleep Never || true
          
          # Start GUI apps safely
          for i in {1..3}; do
            echo "Attempt $i to start GUI..."
            sudo -u runner open -a Finder 2>/dev/null || true
            sudo -u runner open -a Safari 2>/dev/null || true
            sleep 5
          done
          
          echo "GUI activation completed"

      # 3. Install Tailscale
      - name: Install Tailscale
        run: |
          which tailscale || brew install tailscale

      # 4. Connect Tailscale
      - name: Connect Tailscale
        run: |
          sudo brew services start tailscale
          sleep 10
          
          # Connect Tailscale
          sudo tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=gh-runner-macos-$GITHUB_RUN_ID \
            --accept-routes=true
          
          sleep 5
          tsIP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
          echo "Tailscale IP: $tsIP"

      # 5. Verify VNC
      - name: Verify VNC Connection
        run: |
          echo "Checking VNC status..."
          # Check if VNC port is open
          nc -z -v localhost 5900 && echo "VNC Port 5900: OPEN" || echo "VNC Port 5900: CLOSED"
          
          # Check ARD Agent status
          sudo launchctl list | grep -i ard && echo "ARD Agent: RUNNING" || echo "ARD Agent: NOT FOUND"
          
          # Check screen sharing status
          sudo netstat -an | grep 5900 || echo "No VNC listener found"

      # 6. Keep Alive dengan health check
      - name: Maintain VNC Connection
        run: |
          echo "=== VNC ACCESS INFORMATION ==="
          echo "IP: $TAILSCALE_IP"
          echo "Port: 5900" 
          echo "User: runner"
          echo "Password: $VNC_PASSWORD"
          echo "=============================="
          
          # Health check loop
          counter=0
          while [ $counter -lt 216 ]; do  # 360 minutes = 216 * 100 seconds
            echo "[$(date)] VNC Session Active - Duration: $((counter * 100)) seconds"
            
            # Check Tailscale status
            tailscale status || echo "Tailscale not responding"
            
            # Check VNC periodically
            if [ $((counter % 6)) -eq 0 ]; then  # Every ~10 minutes
              nc -z -w 1 localhost 5900 && echo "VNC: HEALTHY" || echo "VNC: UNHEALTHY"
            fi
            
            sleep 100
            counter=$((counter + 1))
          done
