name: Remote Desktop + Tailscale (Linux)

on:
  workflow_dispatch:

jobs:
  remote-desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # adjust as needed; keep job running while you remote in
    steps:
      - name: Checkout (optional)
        uses: actions/checkout@v4

      - name: Make setup script executable
        run: |
          mkdir -p tools
          cat > tools/setup-remote-tail.sh <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail
          
          # --- variables
          DISPLAY_NUM=":1"
          SCREEN_RES="1280x800x24"
          TAILSCALE_AUTHKEY="${TAILSCALE_AUTHKEY:-}"
          HOSTNAME="${HOSTNAME:-gh-runner}"
          TMUX_SESSION="remote_desktop"
          LOG_DIR="$HOME/remote_logs"
          mkdir -p "$LOG_DIR"

          # Update & install required packages
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            xfce4 xfce4-terminal xfce4-session \
            x11vnc xvfb xauth dbus-x11 git wget curl tmux ca-certificates

          # Start Xvfb on :1
          if ! pgrep -f "Xvfb :1" > /dev/null; then
            nohup Xvfb ${DISPLAY_NUM} -screen 0 ${SCREEN_RES} > "$LOG_DIR/xvfb.log" 2>&1 &
            sleep 1
          fi

          export DISPLAY=${DISPLAY_NUM}
          export XAUTHORITY="$HOME/.Xauthority"

          # Start dbus (some DE need it)
          if ! pgrep -f "dbus-daemon --session" > /dev/null; then
            dbus-launch --exit-with-session >/dev/null 2>&1 || true
          fi

          # Start a lightweight XFCE session in background if not running
          if ! pgrep -f "xfce4-session" > /dev/null; then
            nohup bash -lc "startxfce4 >/dev/null 2>&1" &
            sleep 2
          fi

          # Install Tailscale
          if ! command -v tailscale >/dev/null; then
            curl -fsSL https://tailscale.com/install.sh | sh
          fi

          # Start tailscaled and bring interface up with authkey (must be provided)
          sudo tailscaled --tun=userspace-networking > "$LOG_DIR/tailscaled.log" 2>&1 &
          sleep 2

          if [ -z "$TAILSCALE_AUTHKEY" ]; then
            echo "ERROR: TAILSCALE_AUTHKEY not set. Set secret TAILSCALE_AUTHKEY in GitHub Actions." >&2
            exit 2
          fi

          # bring tailscale up
          sudo tailscale up --authkey="${TAILSCALE_AUTHKEY}" --accept-routes=false --hostname="${HOSTNAME}" --tun=userspace-networking > "$LOG_DIR/tailscale_up.log" 2>&1 || true
          sleep 2

          # Start x11vnc (no password by default â€” recommended to set a password or restrict via tailscale)
          if ! pgrep -f "x11vnc -display" > /dev/null; then
            nohup x11vnc -display ${DISPLAY} -forever -shared -noxrecord -noxfixes -noxdamage -bg -o "$LOG_DIR/x11vnc.log" >/dev/null 2>&1 || true
            sleep 1
          fi

          # Optionally, set a VNC password (uncomment and set)
          # mkdir -p $HOME/.vnc
          # printf "yourpassword\nyourpassword\n" | vncpasswd $HOME/.vnc/passwd
          # chmod 600 $HOME/.vnc/passwd
          # start x11vnc with -rfbauth $HOME/.vnc/passwd

          # Print status and Tailscale IP
          echo "=== Processes ==="
          ps aux | egrep "Xvfb|xfce4-session|x11vnc|tailscaled|tailscale" || true
          echo
          echo "=== Tailscale status (may require a moment to appear) ==="
          sudo tailscale status --json || sudo tailscale status || true
          echo
          echo "=== Get Tailscale IPs ==="
          sudo tailscale ip -4 || true
          sudo tailscale ip -6 || true
          echo
          echo "If tailscale up succeeded, connect your VNC client to <TAILSCALE_IP>:5900"
          EOF

          chmod +x tools/setup-remote-tail.sh

      - name: Run setup script (starts X, XFCE, x11vnc, tailscale)
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
          HOSTNAME: gh-runner-remote
        run: |
          # keep job alive and run in tmux so log remains accessible
          ./tools/setup-remote-tail.sh | tee setup.log

      - name: Show quick connection hints
        run: |
          echo "---- tail status ----"
          sudo tailscale status || true
          echo "---- tailscale ip -----"
          sudo tailscale ip -4 || true
          echo "Connect VNC client to <tailscale-ip>:5900 (VNC protocol)."
