name: VNC_TIPSUNIX_macOS

on:
  workflow_dispatch:

jobs:
  secure-vnc:
    runs-on: macos-14
    timeout-minutes: 360

    steps:
      # Langkah 1: Siapkan VNC dan Password (Tidak berubah)
      - name: Generate Password and Enable VNC
        run: |
          VNC_PASS=$(openssl rand -base64 12)
          echo "VNC_PASSWORD=$VNC_PASS" >> $GITHUB_ENV
          echo "Password VNC (akan muncul di log): $VNC_PASS"
          
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate \
            -configure \
            -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "$VNC_PASS" \
            -restart -agent \
            -privs -all -users runner

      # Langkah 2: PERUBAHAN - Install Tailscale via Homebrew
      - name: Install Tailscale via Homebrew
        run: brew install tailscale

      # Langkah 3: PERUBAHAN - Hubungkan Tailscale (Manual)
      - name: Establish Tailscale Connection
        run: |
          # Dapatkan path tailscale dari Homebrew (biasanya /opt/homebrew/bin/tailscale)
          TS_BIN=$(which tailscale)
          echo "Tailscale binary found at: $TS_BIN"
          
          # Gunakan 'nohup' dan '&' untuk menjalankan di background
          # Ini untuk menghindari error 'Killed: 9 / Error 137'
          echo "Menjalankan Tailscale up di background..."
          nohup sudo $TS_BIN up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=gh-runner-macos-$GITHUB_RUN_ID &
          
          # Beri waktu 10 detik agar Tailscale daemon stabil
          echo "Menunggu 10 detik agar Tailscale terhubung..."
          sleep 10
          
          # Tunggu Tailscale mendapatkan IP
          tsIP=""
          retries=0
          while [ -z "$tsIP" ] && [ $retries -lt 10 ]; do
            echo "Mencari IP Tailscale... (Percobaan $((retries+1)))"
            tsIP=$($TS_BIN ip -4)
            sleep 5
            retries=$((retries + 1))
          done
          
          if [ -z "$tsIP" ]; then
            echo "::error::Gagal mendapatkan IP Tailscale. Keluar."
            $TS_BIN status
            exit 1
          fi
          
          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
          echo "IP Tailscale berhasil didapat: $tsIP"

      # Langkah 4: Verifikasi Port VNC (Tidak berubah)
      - name: Verify VNC Accessibility
        run: |
          echo "Tailscale IP: $TAILSCALE_IP"
          echo "Menguji port VNC 5900 pada $TAILSCALE_IP..."
          
          if ! nc -z -v $TAILSCALE_IP 5900; then
            echo "::warning::Koneksi TCP ke port VNC 5900 gagal"
          else
            echo "Konektivitas TCP (VNC) berhasil!"
          fi

      # Langkah 5: Jaga Koneksi (Final)
      - name: Maintain Connection
        run: |
          # Dapatkan path tailscale lagi
          TS_BIN=$(which tailscale)
        
          echo ""
          echo "=== VNC ACCESS ==="
          echo "http://www.youtube.com/@TipsUNIX"
          echo "Alamat (Tailscale IP): $TAILSCALE_IP"
          echo "Port: 5900"
          echo "Username: runner"
          echo "Password: $VNC_PASSWORD"
          echo "===================="
          echo ""
          
          while true; do
            echo "[$(date)] VNC Aktif - Gunakan 'Cancel workflow' untuk menghentikan"
            # Tampilkan status Tailscale untuk debugging
            $TS_BIN status
            sleep 300
          done
