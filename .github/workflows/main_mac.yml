name: VNC_TIPSUNIX_macOS

on:
  workflow_dispatch:

jobs:
  secure-vnc:
    runs-on: macos-14
    timeout-minutes: 360

    steps:
      # Langkah 1: Siapkan VNC dan Password (Sudah OK)
      - name: Generate Password and Enable VNC
        run: |
          VNC_PASS=$(openssl rand -base64 12)
          echo "VNC_PASSWORD=$VNC_PASS" >> $GITHUB_ENV
          echo "Password VNC (akan muncul di log): $VNC_PASS"
          
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate \
            -configure \
            -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "$VNC_PASS" \
            -restart -agent \
            -privs -all -users runner

      # Langkah 2: Install Tailscale via Homebrew (Sudah OK)
      - name: Install Tailscale via Homebrew
        run: brew install tailscale

      # Langkah 3: PERUBAHAN BESAR - Start Daemon dan Hubungkan
      - name: Establish Tailscale Connection
        run: |
          # Dapatkan path tailscale dari Homebrew
          TS_BIN=$(which tailscale)
          echo "Tailscale binary found at: $TS_BIN"
          
          # 1. Start daemon/service menggunakan 'brew services'
          # Inilah yang hilang sebelumnya.
          echo "Starting Tailscale daemon via brew services..."
          sudo brew services start tailscale
          
          # 2. Beri waktu 5 detik agar daemon-nya siap
          echo "Waiting 5 seconds for daemon to initialize..."
          sleep 5
          
          # 3. Sekarang jalankan 'up' (ini adalah klien)
          # Tidak perlu 'nohup' atau '&' karena daemon sudah berjalan
          echo "Connecting to Tailscale..."
          sudo $TS_BIN up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=gh-runner-macos-$GITHUB_RUN_ID
          
          # 4. Beri waktu untuk terhubung sebelum polling IP
          echo "Waiting 5 seconds for connection to establish..."
          sleep 5
          
          # 5. Polling IP (seperti sebelumnya)
          tsIP=""
          retries=0
          while [ -z "$tsIP" ] && [ $retries -lt 10 ]; do
            echo "Mencari IP Tailscale... (Percobaan $((retries+1)))"
            tsIP=$($TS_BIN ip -4)
            sleep 5
            retries=$((retries + 1))
          done
          
          if [ -z "$tsIP" ]; then
            echo "::error::Gagal mendapatkan IP Tailscale. Keluar."
            sudo $TS_BIN status
            exit 1
          fi
          
          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
          echo "IP Tailscale berhasil didapat: $tsIP"

      # Langkah 4: Verifikasi Port VNC (Tidak berubah)
      - name: Verify VNC Accessibility
        run: |
          echo "Tailscale IP: $TAILSCALE_IP"
          echo "Menguji port VNC 5900 pada $TAILSCALE_IP..."
          
          if ! nc -z -v $TAILSCALE_IP 5900; then
            echo "::warning::Koneksi TCP ke port VNC 5900 gagal"
          else
            echo "Konektivitas TCP (VNC) berhasil!"
          fi

      # Langkah 5: Jaga Koneksi (Final - Tidak berubah)
      - name: Maintain Connection
        run: |
          TS_BIN=$(which tailscale)
          echo ""
          echo "=== VNC ACCESS ==="
          echo "http://www.youtube.com/@TipsUNIX"
          echo "Alamat (Tailscale IP): $TAILSCALE_IP"
          echo "Port: 5900"
          echo "Username: runner"
          echo "Password: $VNC_PASSWORD"
          echo "===================="
          echo ""
          
          while true; do
            echo "[$(date)] VNC Aktif - Gunakan 'Cancel workflow' untuk menghentikan"
            sudo $TS_BIN status
            sleep 300
          done
