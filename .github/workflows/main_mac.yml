name: VNC_TIPSUNIX_macOS

on:
  workflow_dispatch:

jobs:
  secure-vnc:
    # Tetap gunakan macos-14 untuk stabilitas VNC
    runs-on: macos-14
    timeout-minutes: 360

    steps:
      # Langkah 1: Siapkan VNC dan Password
      # (Ini sudah berfungsi di log terakhir Anda)
      - name: Generate Password and Enable VNC
        run: |
          VNC_PASS=$(openssl rand -base64 12)
          echo "VNC_PASSWORD=$VNC_PASS" >> $GITHUB_ENV
          echo "Password VNC (akan muncul di log): $VNC_PASS"
          
          # Perintah kickstart VNC dengan sintaks -users yang sudah benar
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate \
            -configure \
            -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "$VNC_PASS" \
            -restart -agent \
            -privs -all -users runner

      # Langkah 2: Gunakan Action Resmi Tailscale
      # Ini adalah PERUBAHAN UTAMA untuk menghindari error 'Killed: 9'
      - name: Install and Connect Tailscale
        uses: tailscale/github-action@v2
        with:
          # Gunakan secret Anda
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}
          # Buat hostname yang unik
          hostname: gh-runner-macos-${{ github.run_id }}
          
      # Langkah 3: Dapatkan IP Tailscale
      # Kita perlu langkah ini karena action di atas tidak otomatis 
      # menyimpan IP ke GITHUB_ENV
      - name: Get Tailscale IP
        run: |
          tsIP=""
          retries=0
          # Beri waktu 5 detik agar IP ter-assign
          echo "Menunggu Tailscale mendaftarkan IP..."
          sleep 5 
          
          while [ -z "$tsIP" ] && [ $retries -lt 10 ]; do
            echo "Mencari IP Tailscale... (Percobaan $((retries+1)))"
            # Path-nya sama, kita hanya perlu query IP
            tsIP=$(/Applications/Tailscale.app/Contents/MacOS/Tailscale ip -4)
            sleep 3
            retries=$((retries + 1))
          done

          if [ -z "$tsIP" ]; then
            echo "::error::Gagal mendapatkan IP Tailscale setelah action."
            /Applications/Tailscale.app/Contents/MacOS/Tailscale status
            exit 1
          fi
          
          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
          echo "IP Tailscale berhasil didapat: $tsIP"

      # Langkah 4: Verifikasi Port VNC (Opsional tapi bagus)
      - name: Verify VNC Accessibility
        run: |
          echo "Tailscale IP: $TAILSCALE_IP"
          echo "Menguji port VNC 5900 pada $TAILSCALE_IP..."
          
          if ! nc -z -v $TAILSCALE_IP 5900; then
            echo "::warning::Koneksi TCP ke port VNC 5900 gagal"
          else
            echo "Konektivitas TCP (VNC) berhasil!"
          fi

      # Langkah 5: Jaga Koneksi (Final)
      - name: Maintain Connection
        run: |
          echo ""
          echo "=== VNC ACCESS ==="
          echo "http://www.youtube.com/@TipsUNIX"
          echo "Alamat (Tailscale IP): $TAILSCALE_IP"
          echo "Port: 5900"
          echo "Username: runner"
          echo "Password: $VNC_PASSWORD"
          echo "===================="
          echo ""
          
          while true; do
            echo "[$(date)] VNC Aktif - Gunakan 'Cancel workflow' untuk menghentikan"
            # Tampilkan status Tailscale untuk debugging
            /Applications/Tailscale.app/Contents/MacOS/Tailscale status
            sleep 300
          done
