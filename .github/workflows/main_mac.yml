name: VNC_TIPSUNIX_macOS

on:
  workflow_dispatch:

jobs:
  secure-vnc:
    # Menggunakan macos-14 (Sonoma) yang lebih stabil.
    # Jika Anda benar-benar butuh macos-15 (Sequoia), ganti ini ke macos-15
    runs-on: macos-14 
    timeout-minutes: 360

    steps:
      - name: Generate Password and Enable VNC
        run: |
          VNC_PASS=$(openssl rand -base64 12)
          echo "VNC_PASSWORD=$VNC_PASS" >> $GITHUB_ENV
          
          echo "Password VNC (akan muncul di log): $VNC_PASS"
          
          # Aktifkan dan konfigurasikan Apple Remote Desktop (VNC)
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate \
            -configure \
            -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "$VNC_PASS" \
            -restart -agent \
            -privs -all -users runner  # <-- PERBAIKAN: Menggunakan -users (plural)

      - name: Install Tailscale
        run: |
          curl -o $RUNNER_TEMP/tailscale.pkg https://pkgs.tailscale.com/stable/Tailscale.pkg
          sudo installer -pkg $RUNNER_TEMP/tailscale.pkg -target /
          rm $RUNNER_TEMP/tailscale.pkg

      - name: Establish Tailscale Connection
        run: |
          # Atur Tailscale agar berjalan dalam mode 'unattended' (penting untuk CI)
          sudo /Applications/Tailscale.app/Contents/MacOS/Tailscale set --unattended

          # PERBAIKAN: Gunakan 'nohup' dan '&' untuk menjalankan di background
          # Ini mencegah runner membunuh proses (Killed: 9 / Error 137)
          echo "Menjalankan Tailscale up di background..."
          nohup sudo /Applications/Tailscale.app/Contents/MacOS/Tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=gh-runner-macos-$GITHUB_RUN_ID &
          
          # Beri waktu 10 detik agar Tailscale daemon stabil sebelum polling IP
          echo "Menunggu 10 detik agar Tailscale terhubung..."
          sleep 10
          
          # Tunggu Tailscale mendapatkan IP
          tsIP=""
          retries=0
          while [ -z "$tsIP" ] && [ $retries -lt 10 ]; do
            echo "Mencari IP Tailscale... (Percobaan $((retries+1)))"
            # Kita tidak perlu sudo untuk 'ip'
            tsIP=$(/Applications/Tailscale.app/Contents/MacOS/Tailscale ip -4)
            sleep 5
            retries=$((retries + 1))
          done
          
          if [ -z "$tsIP" ]; then
            echo "::error::Gagal mendapatkan IP Tailscale. Keluar."
            # Tampilkan status Tailscale untuk debugging
            /Applications/Tailscale.app/Contents/MacOS/Tailscale status
            exit 1
          fi
          
          echo "TAILSCALE_IP=$tsIP" >> $GITHUB_ENV
          echo "IP Tailscale didapat: $tsIP"

      - name: Verify VNC Accessibility
        run: |
          echo "Tailscale IP: $TAILSCALE_IP"
          
          # Tes konektivitas ke port VNC (5900)
          echo "Menguji port VNC 5900 pada $TAILSCALE_IP..."
          
          # Tambahkan 'nc' (netcat) untuk mengetes port
          if ! nc -z -v $TAILSCALE_IP 5900; then
            echo "::warning::Koneksi TCP ke port VNC 5900 gagal"
          else
            echo "Konektivitas TCP (VNC) berhasil!"
          fi

      - name: Maintain Connection
        run: |
          echo ""
          echo "=== VNC ACCESS ==="
          echo "http://www.youtube.com/@TipsUNIX"
          echo "Alamat (Tailscale IP): $TAILSCALE_IP"
          echo "Port: 5900"
          echo "Username: runner"
          echo "Password: $VNC_PASSWORD"
          echo "===================="
          echo ""
          
          # Jaga agar runner tetap aktif
          while true; do
            echo "[$(date)] VNC Aktif - Gunakan 'Cancel workflow' untuk menghentikan"
            # Tampilkan status Tailscale setiap 5 menit
            /Applications/Tailscale.app/Contents/MacOS/Tailscale status
            sleep 300
          done
